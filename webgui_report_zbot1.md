#analyzing the results generated for the "zbot" malware sample 353f3b54de9ecfd82c63a2aeaf1c3b9c

# Analyzing a "zbot" sample and checking the results #

To shown you some of the results you can obtain with the "Mandingo's Sandbox", I've downloaded one "zbot" malware sample from "zeustracker" that it's currently alive (C&C is on).

The MD5 hash for this sample is "353f3b54de9ecfd82c63a2aeaf1c3b9c" and you can found it here (I hope):

https://zeustracker.abuse.ch/monitor.php?browse=binaries&filter=online

# Working from the command line #

You can submit this sample from the command line with the "client.py" script -provided with the "sinjector\_client" application and located in their main folder-, using as arguments:

  1. the IP address of the guest system
  1. the path of the sample you want to analyze

```
$ ./client.py 
Usage: ./client.py <host> <sample> (ex: 192.168.56.101 fileToAnalyze.ex_)
$ ./client.py 192.168.56.201 samples/ZeuS_binary_353f3b54de9ecfd82c63a2aeaf1c3b9c.ex_ 
```

This sample was running and monitored during 1 minute in the virtual guest os "Windows XP SP3 32bit"; you can change the amount of time dedicated to the analysis modifying the variable "SECONDS=60" of the "client.py" script.

Let's see what files were generated from the console as the result of the analysis, and see what we can do working in "text mode".

After analyzing the sample, the results were automaticaly stored in the folder "sinjector\_client/results/", subfolder "353f3b54de9ecfd82c63a2aeaf1c3b9c" (MD5 hash of the sample), so we can move there now and see what we have:

```
$ ls
C:\DOCUME~1\user\LOCALS~1\Temp\agitators.ffw
C:\DOCUME~1\user\LOCALS~1\Temp\nseF.tmp\agitators.dll
C:\DOCUME~1\user\LOCALS~1\Temp\nslD.tmp\agitators.dll
C:\DOCUME~1\user\LOCALS~1\Temp\tmp172d10c8.bat
C:\Documents and Settings\user\Application Data\Microsoft\Address Book\user.wab
C:\Documents and Settings\user\Application Data\Microsoft\CryptnetUrlCache\Content\23B523C9E7746F715D33C6527C18EB9D
C:\Documents and Settings\user\Application Data\Microsoft\CryptnetUrlCache\Content\8A574ED5927B3CEC9626151D220C7448
C:\Documents and Settings\user\Application Data\Microsoft\CryptnetUrlCache\MetaData\23B523C9E7746F715D33C6527C18EB9D
C:\Documents and Settings\user\Application Data\Microsoft\CryptnetUrlCache\MetaData\8A574ED5927B3CEC9626151D220C7448
C:\Documents and Settings\user\Application Data\Nouc\uwutu.idr
C:\Documents and Settings\user\Application Data\Nouc\uwutu.tmp
C:\Documents and Settings\user\Application Data\Vamop\voli.exe
C:\Documents and Settings\user\Cookies\index.dat
C:\Documents and Settings\user\IETldCache\index.dat
C:\Documents and Settings\user\Local Settings\Application Data\Identities\{34C6607A-A5A0-417E-8029-5DCD3B5BAEAF}\Microsoft\Outlook Express\Folders.dbx
C:\Documents and Settings\user\Local Settings\Application Data\Identities\{34C6607A-A5A0-417E-8029-5DCD3B5BAEAF}\Microsoft\Outlook Express\Inbox.dbx
C:\Documents and Settings\user\Local Settings\Application Data\Identities\{34C6607A-A5A0-417E-8029-5DCD3B5BAEAF}\Microsoft\Outlook Express\Offline.dbx
C:\Documents and Settings\user\Local Settings\History\History.IE5\index.dat
C:\Documents and Settings\user\Local Settings\Temporary Internet Files\Content.IE5\OLURW1AV\config[1].dll
C:\Documents and Settings\user\Local Settings\Temporary Internet Files\Content.IE5\OLURW1AV\gate[1].php
C:\Documents and Settings\user\Local Settings\Temporary Internet Files\Content.IE5\OLURW1AV\webhp[1].txt
C:\Documents and Settings\user\Local Settings\Temporary Internet Files\Content.IE5\index.dat
C:\WINDOWS\system32\WBEM\Logs\wbemprox.log
deleted_C:\DOCUME~1\user\LOCALS~1\Temp\nseF.tmp\agitators.dll
deleted_C:\DOCUME~1\user\LOCALS~1\Temp\nslD.tmp\agitators.dll
deleted_C:\DOCUME~1\user\LOCALS~1\Temp\tmp172d10c8.bat
deleted_C:\Documents and Settings\user\Local Settings\Application Data\Google\Chrome\User Data\Default\Pepper Data\Shockwave Flash\WritableRoot\#SharedObjects\DEZBBYAE\macromedia.com\support\flashplayer\sys\settings.sol
deleted_C:\Documents and Settings\user\Local Settings\Temporary Internet Files\Content.IE5\OLURW1AV\config[1].dll
deleted_C:\Documents and Settings\user\Local Settings\Temporary Internet Files\Content.IE5\OLURW1AV\gate[1].php
deleted_C:\Documents and Settings\user\Local Settings\Temporary Internet Files\Content.IE5\OLURW1AV\webhp[1].txt
deleted_C:\sinjector\binary4
network.pcap
newlog.text
processes.txt
processes_final.txt
screenshot-1secs.png
screenshot-40secs.png
screenshot-59secs.png
```

## What is each file? ##

  1. "**newlog.text**" is the log file generated by the "sinjector\_exe" application that runs in the virtual guest system and monitors the API calls of the sample submitted
  1. "**network.pcap**" is a .pcap file with the network traffic generated (using "tcpdump") from/to the virtual "host-only" interface ("vboxnet0") and stores the communications between the guest system and Internet.
  1. "**processes.txt**" and "**processes\_final.txt**" are two list with the processes that were running before and after the sample was launched, respectively.
  1. "**screenshot-\d+segs.png**" files are image files/screenshots of the desktop, taken while the sample was analyzed at different moments.
  1. Files starting with "**deteled**" are files that were deleted by the sample after running.
  1. The rest of files were generated by the sample in any moment.

We can look for any other copy of the malware was created or deleted in this directory by their MD5 hash:

```
$ md5 *|grep 353f3b54de9ecfd82c63a2aeaf1c3b9c
MD5 (deleted_C:\sinjector\binary4) = 353f3b54de9ecfd82c63a2aeaf1c3b9c
```

"C:\sinjector\binary4" is the name that was chosen by "client.py" for uploading the original sample (not the MD5). Since it's "deleted", it means that the malware deleted himself sometime; probably after running it's main process.

Some files can be easy displayed from the console, for example the generated text files, so you can "grep" or parse them with any tool. There're several tools in the "sinjector\_client/scripts" folder to parse those files, also the binaries.

For example, to get the deleted from the sample analyzed, you can run "./scripts/deleted\_files.py" against "newlog.text":
```
$ ./scripts/deleted_files.py results/353f3b54de9ecfd82c63a2aeaf1c3b9c/newlog.text 
C:\DOCUME~1\user\LOCALS~1\Temp\nseF.tmp|1544
C:\DOCUME~1\user\LOCALS~1\Temp\nseF.tmp\agitators.dll|1544
C:\DOCUME~1\user\LOCALS~1\Temp\nslD.tmp|1408
C:\DOCUME~1\user\LOCALS~1\Temp\nslD.tmp\agitators.dll|1408
C:\DOCUME~1\user\LOCALS~1\Temp\nspC.tmp|1408
C:\DOCUME~1\user\LOCALS~1\Temp\nszE.tmp|1544
C:\DOCUME~1\user\LOCALS~1\Temp\tmp172d10c8.bat|912
C:\Documents and Settings\user\Application Data\Nouc\uwutu.tmp|1152
C:\Documents and Settings\user\Local Settings\Application Data\Google\Chrome\User Data\Default\Pepper Data\Shockwave Flash\WritableRoot\#SharedObjects\DEZBBYAE\macromedia.com\support\flashplayer\sys\settings.sol|152,196
C:\Documents and Settings\user\Local Settings\Application Data\Identities\{34C6607A-A5A0-417E-8029-5DCD3B5BAEAF}\Microsoft\Outlook Express\Sent Items.dbx|152
C:\Documents and Settings\user\Local Settings\Temporary Internet Files\Content.IE5\OLURW1AV\config[1].dll|2300,1152
C:\Documents and Settings\user\Local Settings\Temporary Internet Files\Content.IE5\OLURW1AV\gate[1].php|1152
C:\Documents and Settings\user\Local Settings\Temporary Internet Files\Content.IE5\OLURW1AV\webhp[1].txt|1152
C:\sinjector\binary4|912
```

Let's see if some ".exe" file was dropped in the system with "created\_files.py" and "grep":

```
$ ./scripts/created_files.py results/353f3b54de9ecfd82c63a2aeaf1c3b9c/newlog.text|grep exe
C:\Documents and Settings\user\Application Data\Vamop\voli.exe|328
```

The number "328" after the character "|" is the process that created (dropped) "voli.exe".

With "parse\_log.py" we can see what was the behavior of the sample, filter by process (-pid), and filter out the registry calls (-reg) or procedure calls (-proc) so we can get a more compact view.

```
$ ./scripts/parse_log.py 
Usage: ./scripts/parse_log.py <sinjector_logfile> [-pid pid] [-reg] [-proc]
```

Let's see a very compact view of the process "328":

```
$ ./scripts/parse_log.py results/353f3b54de9ecfd82c63a2aeaf1c3b9c/newlog.text -pid 328 -reg -proc
[328   ] [CreateFileW (gREA gWRI OE 0xc0000000)] \\.\PIPE\lsarpc
[328   ] [CreateFileW (OE 0x0)] C:\WINDOWS\
[328   ] [CreateFileW (OE 0x0)] \\.\MountPointManager
[328   ] [RegCreateKeyExW] handle=0xe0 MAXIMUM_ALLOWED "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders"
[328   ] [RegCreateKeyExW] handle=0xe0 MAXIMUM_ALLOWED "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders"
[328   ] [RegSetValueExW] REG_SZ "handle(0xe0)\AppData" "C:\Documents and Settings\user\Application Data"
[328   ] [CreateFileW (gREA OE 0x80000000)] C:\sinjector\binary4
[328   ] [CreateFileW (gREA gWRI OE 0xc0000000)] C:\Documents and Settings\user\Application Data\Vamop\voli.exe
[328   ] [CreateFileW (gREA gWRI OE 0xc0000000)] C:\Documents and Settings\user\Application Data\Nouc\uwutu.idr
[328   ] [CreateFileW (gREA gWRI OE 0xc0000000)] C:\Documents and Settings\user\Application Data\Dosed\izymw.aky
[328   ] [RegCreateKeyExW] handle=0xe8 ALL_ACCESS "HKCU\SOFTWARE\Microsoft"
[328   ] [RegCreateKeyExW] handle=0xec ALL_ACCESS "handle(0xe8)\Vowee"
[328   ] [Sleep] 20
[328   ] [CreateFileW (gWRI OE 0x40000000)] C:\Documents and Settings\user\Application Data\Vamop\voli.exe
[328   ] [CreateFileW (gREA OE 0x80000000)] C:\Documents and Settings\user\Application Data
[328   ] [CreateFileW (fWattr OE 0x100)] C:\Documents and Settings\user\Application Data\Vamop\voli.exe
[328   ] [CreateFileW (fWattr OE 0x100)] C:\Documents and Settings\user\Application Data\Vamop
[328   ] [CreateFileW (fWattr OE 0x100)] C:\Documents and Settings\user\Application Data\Nouc\uwutu.idr
[328   ] [CreateFileW (fWattr OE 0x100)] C:\Documents and Settings\user\Application Data\Nouc
[328   ] [CreateFileW (fWattr OE 0x100)] C:\Documents and Settings\user\Application Data\Dosed\izymw.aky
[328   ] [CreateFileW (fWattr OE 0x100)] C:\Documents and Settings\user\Application Data\Dosed
[328   ] [CreateProcessW] PID=1544 Handle=244 Thread=248 "" "C:\Documents and Settings\user\Application Data\Vamop\voli.exe"
[328   ] [REINJECT] "C:\sinjector\sinjector.exe" /p 1544  
[328   ] [CreateFileW (gWRI OE 0x40000000)] C:\DOCUME~1\user\LOCALS~1\Temp\tmp172d10c8.bat
[328   ] [CreateFileW (gREA OE 0x80000000)] C:\WINDOWS\system32\cmd.exe
[328   ] [CreateProcessW] PID=912 Handle=248 Thread=232 "" "C:\WINDOWS\system32\cmd.exe" /c "C:\DOCUME~1\user\LOCALS~1\Temp\tmp172d10c8.bat"
```

In the log above we can see lot of the behavior of this malware, don't you think? :)

Let's see what is that ".bat" file:

```
$ cat results/353f3b54de9ecfd82c63a2aeaf1c3b9c/deleted_C\:\\DOCUME~1\\user\\LOCALS~1\\Temp\\tmp172d10c8.bat 
@echo off
:d
del "C:\sinjector\binary4"
if exist "C:\sinjector\binary4" goto d
del /F "C:\DOCUME~1\user\LOCALS~1\Temp\tmp172d10c8.bat"
```

Ok, some bat script for removing the original file (C:\sinjector\binary4) and himself.

Finally, let's use the "script/reg\_write.py" to see a particular changes in the registry related with executables (filtering by the "exe" string):

```
$ ./scripts/reg_written.py results/353f3b54de9ecfd82c63a2aeaf1c3b9c/newlog.text |grep exe|head -1
[216   ] [RegSetValueExW] REG_SZ "handle(0x1e0)\Zusytuappa" ""C:\Documents and Settings\user\Application Data\Vamop\voli.exe""
```

If we run the script again, and give for parameters the "pid" (216) and the "handle" (0x1e0) we can get some backward information, the creation/opening command that gave that handle:

```
$ ./scripts/reg_written.py results/353f3b54de9ecfd82c63a2aeaf1c3b9c/newlog.text 216 0x1e0
[216   ] [RegCreateKeyExW] handle=0x1e0 ALL_ACCESS "HKCU\Software\Microsoft\Windows\Currentversion\Run"
[216   ] [RegSetValueExW] REG_SZ "handle(0x1e0)\Zusytuappa" ""C:\Documents and Settings\user\Application Data\Vamop\voli.exe""
```

Now, we know (at least) on of the tricks used by this sample to persist in the system against logouts and session reboots.

### Other useful commands/scripts ###

#### Read the version information ####

```
$ ./scripts/pe_fileinfo.py results/353f3b54de9ecfd82c63a2aeaf1c3b9c/deleted_C\:\\sinjector\\binary4 
ProductVersion: 6.00.8.10
FileVersion: 6.00.8.10
ProductName: BCB6 Evaluation Edition
```

#### Get the sections of the binary ####

```
$ ./scripts/pe_sections.py results/353f3b54de9ecfd82c63a2aeaf1c3b9c/deleted_C\:\\sinjector\\binary4 
('.text\x00\x00\x00', '0x1000', '0x5a68', 23552)
('.rdata\x00\x00', '0x7000', '0x11ce', 4608)
('.data\x00\x00\x00', '0x9000', '0x1a7b8', 1024)
('.ndata\x00\x00', '0x24000', '0x8000', 0)
('.rsrc\x00\x00\x00', '0x2c000', '0xbf8', 3072)
```

#### Display the network traffic (.pcap) ####

```
$ python ./scripts/pcap_reader.py results/353f3b54de9ecfd82c63a2aeaf1c3b9c
TCP 192.168.56.201 1060 87.237.198.245 80 357 "87.237.198.245" "/img/config.dll"
TCP 192.168.56.201 1059 87.237.198.245 80 363 "87.237.198.245" "/img/config.dll"
UDP 192.168.56.201 53185 8.8.8.8 53 34 "time.windows.com" ""
UDP 192.168.56.201 55703 8.8.8.8 53 28 "_LDAP._TCP" ""
UDP 192.168.56.201 59082 8.8.8.8 53 32 "www.google.com" ""
TCP 192.168.56.201 1063 216.58.211.228 80 304 "www.google.com" "/webhp"
UDP 192.168.56.201 64754 8.8.8.8 53 31 "www.google.es" ""
TCP 192.168.56.201 1062 87.237.198.245 80 357 "87.237.198.245" "/img/config.dll"
TCP 192.168.56.201 1064 216.58.211.227 80 476 "www.google.es" "/webhp?gfe_rd=cr&ei=xrThVPGwC7Sp8wfRmoKIAg"
TCP 192.168.56.201 1061 87.237.198.245 80 363 "87.237.198.245" "/img/config.dll"
TCP 192.168.56.201 1065 216.58.211.227 443 77 "" ""
TCP 192.168.56.201 1065 216.58.211.227 443 314 "" ""
UDP 192.168.56.201 60802 8.8.8.8 53 34 "crl.geotrust.com" ""
TCP 192.168.56.201 1066 23.54.133.163 80 188 "crl.geotrust.com" "/crls/secureca.crl"
UDP 192.168.56.201 61110 8.8.8.8 53 34 "time.windows.com" ""
UDP 192.168.56.201 60615 8.8.8.8 53 32 "pki.google.com" ""
TCP 192.168.56.201 1067 216.58.211.238 80 178 "pki.google.com" "/GIAG2.crl"
TCP 192.168.56.201 1065 216.58.211.227 443 512 "" ""
UDP 192.168.56.201 61294 8.8.8.8 53 28 "_LDAP._TCP" ""
TCP 192.168.56.201 1062 87.237.198.245 80 609 "87.237.198.245" "/img/gate.php"
UDP 192.168.56.201 137 192.168.56.255 137 50 "" ""
...
```

We can dump a specific packet content if we provide the number of the packet:

```
$ python ./scripts/pcap_reader.py results/353f3b54de9ecfd82c63a2aeaf1c3b9c 1
POST /img/config.dll HTTP/1.1
Accept: */*
User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; .NET4.0C; .NET4.0E)
Host: 87.237.198.245
Content-Length: 122
Connection: Keep-Alive
Cache-Control: no-cache

???????f?b[?wOT?YX٤ޢXb???"4D]A?&?Xsbٵ?:`?A???T??b???2Q??^1űXA?N?J??????}?N?????[?[?E.??
```

#### Show the affected processes ####

```
$ ./scripts/affected_processes.py results/353f3b54de9ecfd82c63a2aeaf1c3b9c/newlog.text |sort
1016   written  unknown unknown
1108   open     running svchost.exe      
1140   written  unknown unknown
1152   alive    running explorer.exe
1152   open     running explorer.exe
1152   rthread  running explorer.exe
1152   written  running explorer.exe
1216   open     running svchost.exe      
1292   open     running svchost.exe      
1408   created      new C:\sinjector/binary4
1504   open     running spoolsv.exe      
152    open     running vboxtray.exe     
152    rthread  running vboxtray.exe     
152    written  running vboxtray.exe     
1544   created      new "" "C:\Documents and Settings\user\Application Data\Vamop\voli.exe"
1632   created      new "C:\WINDOWS\system32\ipconfig.exe" ipconfig /all
1632   written      new "C:\WINDOWS\system32\ipconfig.exe" ipconfig /all
1920   open     running explorer.exe     
1920   rthread  running explorer.exe     
1920   written  running explorer.exe     
196    open     running jusched.exe      
196    rthread  running jusched.exe      
196    written  running jusched.exe      
2028   created      new "C:\Documents and Settings\user\Application Data\Vamop\voli.exe" (null)
2028   written      new "C:\Documents and Settings\user\Application Data\Vamop\voli.exe" (null)
2036   written  unknown unknown
216    open     running ctfmon.exe       
216    rthread  running ctfmon.exe       
216    written  running ctfmon.exe       
2276   written  unknown unknown
2300   open       other C:\WINDOWS\explorer.exe?
2300   rthread    other C:\WINDOWS\explorer.exe?
2300   written    other C:\WINDOWS\explorer.exe?
2356   created      new "" cmd.exe
2356   written      new "" cmd.exe
2628   open       other C:\WINDOWS\explorer.exe
2628   rthread    other C:\WINDOWS\explorer.exe
2628   written    other C:\WINDOWS\explorer.exe
2912   created      new "" cmd.exe
2912   written      new "" cmd.exe
3000   written  unknown unknown
3132   created      new "C:\WINDOWS\system32\hostname.exe" hostname
3132   written      new "C:\WINDOWS\system32\hostname.exe" hostname
3144   written  unknown unknown
3276   created      new "C:\WINDOWS\system32\tasklist.exe" tasklist
3276   written      new "C:\WINDOWS\system32\tasklist.exe" tasklist
328    created      new "C:\sinjector\binary4" (null)
328    written      new "C:\sinjector\binary4" (null)
3288   written  unknown unknown
3360   alive    running wmiprvse.exe
3408   open       other C:\WINDOWS\explorer.exe
3408   rthread    other C:\WINDOWS\explorer.exe
3408   written    other C:\WINDOWS\explorer.exe
3564   written  unknown unknown
368    open     running smss.exe         
3704   written  unknown unknown
3884   written  unknown unknown
392    open     running alg.exe          
3940   written  unknown unknown
4064   created      new "C:\WINDOWS\system32\tasklist.exe" tasklist
4064   written      new "C:\WINDOWS\system32\tasklist.exe" tasklist
4084   written  unknown unknown
4088   open     running pythonw.exe      
4088   rthread  running pythonw.exe      
4088   written  running pythonw.exe      
476    created      new "C:\WINDOWS\system32\netsh.exe" netsh firewall set opmode disable
476    written      new "C:\WINDOWS\system32\netsh.exe" netsh firewall set opmode disable
576    open     running svchost.exe      
612    open     running csrss.exe        
636    open     running winlogon.exe     
680    open     running services.exe     
692    open     running lsass.exe        
844    open     running vboxservice.exe  
852    open     running wscntfy.exe      
852    rthread  running wscntfy.exe      
852    written  running wscntfy.exe      
888    open     running svchost.exe      
912    created      new "" "C:\WINDOWS\system32\cmd.exe" /c "C:\DOCUME~1\user\LOCALS~1\Temp\tmp172d10c8.bat"
976    open     running svchost.exe
```

#### Display the compression rate of the file ####

Useful to detect compressed/encrypted zones and also odd paddings:

```
$ ./scripts/compression_rate.py results/353f3b54de9ecfd82c63a2aeaf1c3b9c/deleted_C\:\\sinjector\\binary4 
Name PointerToRawData SizeOfRawData VirtualAddress Flags Entropy Dir
.text 0x400 0x5c00 0x1000 code,read,execute 6.4186984047 
.rdata 0x6000 0x1200 0x7000 data,read 5.23558258678 IMAGE_DIRECTORY_ENTRY_IAT
.data 0x7200 0x400 0x9000 data,read,write 4.87122636881 
.ndata 0x0 0x0 0x24000 read,write 0.0 
.rsrc 0x7600 0xc00 0x2c000 data,read 4.46440305751 IMAGE_DIRECTORY_ENTRY_RESOURCE
0 0.629739531817 ".ndata .text" ".ndata .text"
3033 0.720408836136 ".text" ""
6066 0.739861523244 ".text" ""
9099 0.725024727992 ".text" ""
12132 0.708869106495 ".text" ""
15165 0.712495878668 ".text" ""
18198 0.757006264425 ".text" ""
21231 0.615891856248 ".text" ""
24264 0.377184305968 ".text .rdata" ".rdata"
27297 0.534454335641 ".data .rdata .rsrc" ".data .rsrc"
30330 0.475107154632 ".rsrc" ""
33363 1.0 "padding?" "padding?"
36396 1.0 "padding?" ""
39429 1.0 "padding?" ""
...
297234 1.0 "padding?" ""
300267 1.0 "padding?" ""
303300 1.0 "padding?" ""
```

Too much padding before the last declared section (.rsrc), don't you think? Also, the compression rate is "1", that means that the data couldn't be compressed more with "zlib", so, probably it's already compressed.

If you graph this data -this is done automatically from the web gui-, you can "imagine" that this binary... has something clearly undeclared inside him.

![https://mandingo.googlecode.com/svn/trunk/screenshots/sinjector/webgui/webgui_zeus1_graph.png](https://mandingo.googlecode.com/svn/trunk/screenshots/sinjector/webgui/webgui_zeus1_graph.png)

There're more commands and features available from the web gui. This is only a demonstration of the basics of this sandbox engine/laboratory from the command line.

If you want to know more about this sandbox and its features, visit the  [main page](https://code.google.com/p/mandingo/wiki/MandingoSandbox) of this wiki